#!/bin/bash

PACKAGE_VERSION="3.1.5"

usage() {
    err_msg "ì‚¬ìš©ë²•: git-release [-v | --version] [-h | --help] [-M | --major] [-m | --minor] [-p | patch]"
    exit 1
}

exit_on_failed() { 
    echo "$@";
    exit 1; 
}

get_version() {
    echo "v$PACKAGE_VERSION"
    exit 1
}

bump_major() {
    
    exit 1
}

err_msg() { echo "$@" ;} >&2

if [ $# -eq 0 ]
    then
        usage
fi

# long ì˜µì…˜ ì²˜ë¦¬
A=""
bumper=""
while true; do
    [ $# -eq 0 ] && break
    case $1 in
        --major)
            bumper="--major"
            shift; continue
            ;;
        --minor)
            bumper="--minor"
            shift; continue
            ;;
        --patch)
            bumper="--patch"
            shift; continue
            ;;
        --help)
            usage
            shift; continue
            ;;
        --version)
            get_version
            shift; continue
            ;;
        --*) 
            err_msg "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            usage;
            ;;
    esac

    A=$A$([ -n "$A" ] && echo -e "\a")$1
    shift
done

# $@' ê°’ì— short ì˜µì…˜ë§Œ ë‚¨ê¸°ê¸°
IFS=$(echo -e "\a"); set -f; set -- $A; set +f; IFS=$(echo -e " \n\t")

# short ì˜µì…˜ ì²˜ë¦¬
while getopts "Mmphv" opt; do
    case $opt in
        M)
            bumper="--major"
            ;;
        m)
            bumper="--minor"
            ;;
        p)
            bumper="--patch"
            ;;
        h)
            usage
            ;;
        v)
            get_version
            ;;
        *)
            # err_msg "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: -$OPTARG"
            usage
            ;;
    esac
done

shift $(( OPTIND - 1 ))

echo "ğŸš¡ Git releaseë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."

echo ""

# dev ë¸Œëœì¹˜ë¡œ ì „í™˜
dev_branch="dev"
echo "ğŸ™Œ '$dev_branch' ë¸Œëœì¹˜ë¡œ ì „í™˜í•©ë‹ˆë‹¤"
echo "git checkout $dev_branch"
git checkout $dev_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. $dev_branch ë¸Œëœì¹˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."

echo ""

# Origin dev ë¸Œëœì¹˜ ìµœì‹  ì»¤ë°‹ pull & rebase
echo "ğŸ‘† Origin dev ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ì„ pull & rebaseí•©ë‹ˆë‹¤"
echo "git pull --rebase"
git pull --rebase || exit_on_failed "ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."

echo ""

# package.json ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸
echo "ğŸ¤ package.json ë²„ì „ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë²„ì „ì„ íƒœê¹…í•©ë‹ˆë‹¤"
echo "yarn version $bumper"
yarn version $bumper || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."

echo ""

# dev ë¸Œëœì¹˜ í‘¸ì‹œ
echo "ğŸ¤Ÿ '$dev_branch' ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— Originì— í‘¸ì‹œí•©ë‹ˆë‹¤"
echo "git push origin $dev_branch"
git push origin $dev_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."

echo ""

semver=$(cat package.json \
  | grep version \
  | head -1 \
  | awk -F: '{ print $2 }' \
  | sed 's/[",]//g' \
  | tr -d '[[:space:]]')

v_semver="v$semver"

# ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ë¡œ ì „í™˜
release_branch="release/$v_semver"
echo "ğŸ¤˜ ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ $release_branch ë¡œ ì „í™˜í•©ë‹ˆë‹¤"
echo "git checkout -b $release_branch"
git checkout -b $release_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ê³¼ì •ì€ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”."

echo ""

# íƒœê·¸ì™€ í•¨ê»˜ í‘¸ì‹œ
echo "ğŸš€ GitHubì— í‘¸ì‹œí•©ë‹ˆë‹¤. 3..2..1.."
echo "git push origin '$release_branch' && git push origin $v_semver"
git push origin "$release_branch" && git push origin $v_semver || exit_on_failedexit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ê³¼ì •ì€ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”."

echo ""

PACKAGE_NAME=$(cat package.json \
  | grep name \
  | head -1 \
  | awk -F: '{ print $2 }' \
  | sed 's/[",]//g' \
  | tr -d '[[:space:]]')

echo $PACKAGE_NAME

echo "ğŸ’« í‘¸ì‹œ ì™„ë£Œ! ì´ì œ PRì„ ìƒì„±í•  ì‹œê°„ì…ë‹ˆë‹¤"
echo ""
echo "PR ìƒì„± URL:"
echo "==========================================================="
echo "https://github.com/inflearn/$PACKAGE_NAME/pull/new/$release_branch"
echo "==========================================================="

echo ""

echo "ï¸ğŸŒˆ Git release ë§ˆë¬´ë¦¬ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤"

echo ""

echo "$dev_branch ë¸Œëœì¹˜ë¡œ ì „í™˜í•©ë‹ˆë‹¤"
echo "git checkout $dev_branch"
git checkout $dev_branch

echo ""

echo "$release_branch ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤"
echo "git branch -d $release_branch"
git branch -d $release_branch

echo ""

echo "ì§„ì§œ ì•ˆë…•! ğŸ––"